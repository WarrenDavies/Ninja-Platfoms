<!DOCTYPE html>
<html>
<head>

<style>
body{
margin:0;
}

canvas {
border: solid 5px black;
position:relative;
}

#holder {
display:block;
margin: 100px auto 0 auto;
width:800px;
height:600px;
}
</style>

<script>

function init() {
document.getElementById("canvas").focus();
console.log("start");
var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
window.requestAnimationFrame = requestAnimationFrame;

// define variables
var canvas, c;
var INTERVAL = 20;

// set up canvas
canvas = document.getElementById("canvas");
canvas.width = 800;
canvas.height = 600;
c = canvas.getContext("2d");
var WIDTH = canvas.width;
var HEIGHT = canvas.height;
var keyUpHolder = 0;

// initial canvas background 
c.beginPath();
c.fillStyle = "#3399FF";
c.rect(0,0,800,600);
c.fill();
c.closePath();

var WIDTH = canvas.width;
var HEIGHT = canvas.height;
setInterval(mainDraw, INTERVAL);
var keys = [];
var keys2 = [];
var theBadGuys = [];
var thePlatforms = [];
var e = 0;
var camera = {x: 0, y: 0, w: 800, h: 600};
var tileSize = 50;


var platformCollision = true;
var onPlatform = true;
var jumping = false;
var jumped = 0;
var moveY = false;
var moveX = false;
var moved = false;
var platformCollision = false;
var theCoins = [];
var coinsCollected = 0;
var spliced = 0;
var theBullets = [];
var mouse = { x: 0, y: 0, };
var sun = {
	xPosition: 400,
	yPosition: 150,
	sizeStart: 15,
	sizeEnd: 1000,
	timer: 0.5,
}
var sky = {
	status: "day",
	day: {
		r: 51,
		g: 153,
		b: 255,
	},
	sunset: {
		r: 255,
		g: 165,
		b: 0,
	},
	night: {
		r: 19,
		g: 24,
		b: 98,
	},
	current: {
		r: 51,
		g: 153,
		b: 255,
	},
}

function badGuy() {
	this.x = 700;
	this.y = 1000;
	this.w = 20;
	this.h = 60;
	this.maxSpeed = 4;
	this.speed = 1;
	this.fill = 'blue';
}

function pushBadGuy(platform) {
	theBadGuys.push({
		x: thePlatforms[platform].x + (thePlatforms[platform].w / 2) - 25,
		y: thePlatforms[platform].y - 50,
		w: 50,
		h: 50,
		onPlatform: platform,
		leftLimit: thePlatforms[platform].x,
		rightLimit: thePlatforms[platform].x + thePlatforms[platform].w,
		health: 3,
		maxSpeed: 4,
		speed: 1,
		border:' red',
		fill: 'red'
	}); 
}

function multipleCoinPush(x, y, coinsToPush) {
	var distanceFromLeft = 30;
	var spacer = 50;
	for (i = x + distanceFromLeft; i < x + (spacer * 3); i += spacer) {
		theCoins.push({
			x: i,
			y: y -50,
			w: 45,
			h: 45,
			fill:'yellow',
			border:'yellow',
			borderWidth: 0
		});
	}
	
}



// push platforms. Might need to have separate functions to load levels later.	  
	  
// the ground
thePlatforms.push({
	x:0,
	y:830,
	w:840,
	h:400,
	type: "ground",
	location: "left",
	fill:'#6B2400',
	fillTop: 'green',
	fillTopHeight: 20,
	borderWidth: 0,
});

thePlatforms.push({
	x:0,
	y:700,
	w:200,
	h:30,
	type: "ground",
	location: "left",
	fill:'#6B2400',
	border:'#6B2400',
	fillTop: 'green',
	fillTopHeight: 10,
	borderWidth: 0,
});

thePlatforms.push({
	x:600,
	y:600,
	w:220,
	h:30,
	type: "ground",
	location: "right",
	fill:'#6B2400',
	border:'#6B2400',
	fillTop: 'green',
	fillTopHeight: 10,
	borderWidth: 0,
});

thePlatforms.push({
	x:0,
	y:400,
	w:200,
	h:30,
	type: "ground",
	location: "left",
	fill:'#6B2400',
	border:'#6B2400',
	fillTop: 'green',
	fillTopHeight: 10,
	borderWidth: 0,
});

thePlatforms.forEach(function(i, j) {
	if (j != 0) {
		multipleCoinPush(i.x, i.y, 3);
	}
});

jumpUp = new Image();
jumpUp.src = 'jumpUP.png';
    
function updateCamera() {
	camera.y = Player1.y + (Player1.h / 2) - (camera.h / 2);
}


	
	
function Player() {
	this.x = (WIDTH / 2) - 25;
	this.y = (HEIGHT / 2) - 25 + 500;
	this.w = 50;
	this.h = 50;
	this.maxSpeed = 6;
	this.speed = 0;
	this.jumpSpeed = 0;
	this.maxJumpSpeed = 6;
	this.jumpHeight = 500;
	this.momentum = 'none';
	this.fill = 'blue';
	this.onPlatform = -1;
}
var Player1 = new Player();
updateCamera();
console.log(Player1);

function clear(c) {
	c.clearRect(0, 0, WIDTH, HEIGHT);
}

function drawCoins() {
	theCoins.forEach(function(i, j){
		c.beginPath();
		c.save();
		c.fillStyle = i.fill;
		c.arc(i.x + (i.w / 2) - camera.x, i.y + (i.h / 2) - camera.y, i.w / 2, 0, 2 * Math.PI, false);
		c.fill();
		c.restore();
		c.closePath();
	});
} 

function drawPlatforms() {
	thePlatforms.forEach(function(i,j){
		c.beginPath();
		c.lineWidth = i.borderWidth;
		c.strokeStyle = i.border;
		c.fillStyle = i.fill;
		if (sky.status === "sunset") {
			c.fillStyle = "black";
		}
		if (sky.status === "night") {
			c.fillStyle = "white";
		}
		c.fillRect(i.x - camera.x, i.y - camera.y, i.w, i.h);
		if (i.type === "ground") {
			c.fillStyle = i.fillTop;
			if (sky.status === "sunset") {
				c.fillStyle = "black";
			}
		if (sky.status === "night") {
				c.fillStyle = "white";
		}			
			c.fillRect(i.x - camera.x, i.y - camera.y, i.w, i.fillTopHeight); 
		}
		
		c.closePath();
	});
}

function drawPlayer() {
	c.beginPath();
	c.save();
	c.strokeStyle = Player1.border;
	c.fillStyle = Player1.fill;
	c.lineWidth = 0;


	c.rect(Player1.x - camera.x, Player1.y - camera.y, Player1.w, Player1.h);   
	
	c.stroke();
	c.fill();
	c.restore();
	c.closePath();
}

function drawBadGuys() {
	theBadGuys.forEach(function(i,j){
		c.beginPath();
		c.save();
		c.fillStyle = i.fill;
		c.lineWidth = 0;
		c.strokeStyle = i.border;
		c.rect(i.x - camera.x, i.y - camera.y, i.w, i.h);  
		c.stroke();
		c.fill();
		c.restore();
		c.closePath();
	});
}

// collision detection routine where 2 objects have h and w
function collidesObjects(a, b) {
	return	a.x < b.x + b.w &&
			a.x + a.w > b.x &&
			a.y < b.y + b.h &&
			a.y + a.h > b.y;
}

// collision detection where w and h must be specified
function collidesSpecific(ax, ay, aw, ah, bx, by, bw, bh) {
	return  ax < bx + bw &&
			ax + aw > bx &&
			ay < by + bh &&
			ay + ah > by;
}

// collision detection between player and platforms
function checkPlatform() {
	var onPlatform = -1;
	thePlatforms.forEach ( function(i, j) {
		if (collidesSpecific(Player1.x, Player1.y + 3, Player1.w, Player1.h, i.x, i.y, i.w, i.h)) {
			onPlatform = j;
			jumped = 0;
			jumping = false;
			Player1.y = i.y - Player1.h;
			if (Player1.speed === 0) {
				if (i.x + i.w < Player1.x + (Player1.w / 2) || i.x > Player1.x + (Player1.w / 2) ) {
					Player1.fill = 'orange';
				} else {
					Player1.fill = 'blue';
				}
			}
		}
	});
	if (onPlatform > -1) {
		Player1.onPlatform = onPlatform;
		if (Player1.onPlatform >= thePlatforms.length - 3) {
			pushPlatforms();
		}
	} else {
		Player1.onPlatform = -1;
	}
}


/// jumping from first, inside that is jumping to
var platformHeightRanges = {
	left: {
		left: {
			x: 0,
			y: 200,
		},
		middle: {
			x: 300,
			y: 200,
		},
		right: {
			x: 600,
			y: 200,
		},
	},
	middle: {
		left: {
			x: 0,
			y: 200,
		},
		middle: {
			x: 300,
			y: 200,
		},
		right: {
			x: 600,
			y: 200,
		},
	},
	right: {
		left: {
			x: 0,
			y: 200,
		},
		middle: {
			x: 300,
			y: 200,
		},
		right: {
			x: 600,
			y: 200,
		},
	},
}
var g = "left";
var h = "right";
console.log(platformHeightRanges[g][h].x);

function getHeightRange() {
	var currentTopPlatformHeight = thePlatforms[thePlatforms.length - 1].y;
	var currentPlatformLocation = thePlatforms[thePlatforms.length - 1].location
	var locationChooser = Math.ceil(Math.random() * 3);
	var targetPlatformLocation;
	switch (locationChooser) {
		case 1:
			targetPlatformLocation = "left";
			break;
		case 2:
			targetPlatformLocation = "middle";
			break;	
		case 3:
			targetPlatformLocation = "right";
			break;
	}
	console.log(currentPlatformLocation);
	return { 
		x: platformHeightRanges[currentPlatformLocation][targetPlatformLocation].x,
		y: thePlatforms[thePlatforms.length - 1].y - platformHeightRanges[currentPlatformLocation][targetPlatformLocation].y,
		location: targetPlatformLocation,
	}
	
}

function pushPlatforms() {
	for (i = 0; i < 3; i++) {
		var newPlatform = getHeightRange();
		thePlatforms.push({
			x: newPlatform.x,
			y: newPlatform.y,
			w: 220,
			h: 30,
			type: "ground",
			location: newPlatform.location,
			fill: '#6B2400',
			border: '#6B2400',
			fillTop: 'green',
			fillTopHeight: 10,
			borderWidth: 0,
		});	
		if (Math.ceil(Math.random()*2) === 1) {
			multipleCoinPush(newPlatform.x, newPlatform.y, 3);
		} else {
			pushBadGuy(thePlatforms.length - 1);
		}
	}
}

function drawHUD() {
	c.fillStyle = "black";
	c.font = 'bold 28pt Calibri';
	c.fillText("Coins:" + coinsCollected, 20, 30);

}

function checkCoinCollision() {
	if (moveY === true || moveX === true) {
		for (j = theCoins.length - 1; j >= 0; j--) {
			if (collidesObjects(Player1, theCoins[j])) {
				theCoins.splice(j, 1);
				coinsCollected += 1;
			}
		}
	}
}

function createBullet(targetX, targetY, shooterX, shooterY) {
	var deltaX = targetX - shooterX;
	var deltaY = targetY - shooterY;
	var angle = Math.atan2(deltaY, deltaX);
	var xTarget = Math.cos(angle);
	var yTarget = Math.sin(angle);
	theBullets.push( { 
		originX: shooterX,
		originY: shooterY,
		x: shooterX,
		y: shooterY,
		w: 5,
		h: 5,
		power: 1,
		speed: 10,
		xTarget: xTarget,
		yTarget: yTarget,
		color: "black",
	});
}

function updateBullets() {
	theBullets.forEach(function(i, j) {
		if (i.x > WIDTH || i.x < 0 || i.y < i.originY - 1200 || i.y > i.originY + 1200) {
			theBullets.splice(j, 1);
		} 
		theBadGuys.forEach(function(k, l) {
			if (collidesObjects(i, k)) {
				k.health -= i.power;
				theBullets.splice(j, 1);
				if (k.health < 1) {
					theBadGuys.splice(l, 1);
				}
			}
		});
		thePlatforms.forEach(function(k, l) {
			if (collidesObjects(i, k)) {
				theBullets.splice(j, 1);
			}
		});
		i.x += i.xTarget * i.speed;
		i.y += i.yTarget * i.speed;
	});
}

function drawBullets() {
	c.beginPath();
	theBullets.forEach(function(i, j) {
		c.fillRect(i.x, i.y - camera.y, i.w, i.h, i.color);
	});
	if (theBullets[0]) {
		/*c.fillText(theBullets[theBullets.length - 1].x,100,100);
		c.fillText(theBullets[theBullets.length - 1].y,100,150);
		c.fillText(theBullets[theBullets.length - 1].xTarget,100,200);
		c.fillText(theBullets[theBullets.length - 1].yTarget,100,250);
		c.fillText(theBadGuys[theBadGuys.length - 1].health,100,300); */
	}
}




function updateBackground() {
	sun.yPosition += sun.timer;
	if (sun.yPosition > 2000) {
		sun.yPosition = -300;
		sun.sizeStart = 5;
		sun.sizeEnd = 2000;
	}
	
	
	
	
	if (sun.yPosition < 400) {
		sky.status = "day";
	}
	if (sun.yPosition < 400 && sun.yPosition > 300 && sky.current.g > 0) {
		sky.current.g -= 3;
	}

	if (sun.yPosition >= 400) {
		sun.sizeStart += .1;
		sun.sizeEnd += .1;
		sky.status = "sunset";
	}
	if (sun.yPosition >= 800) {
		//sun.sizeStart -= .3;
		if (sun.sizeEnd >= .3) {
			sun.sizeEnd -= .3;
		}		
	}
	if (sun.yPosition >= 1000) {
		//sun.sizeStart -= .3;
		sky.status = "night";
	}
	console.log(sun.yPosition);
	
	for (var rgbCurrent in sky.current) {
		console.log(rgbCurrent);
		console.log("current: " + sky.current[rgbCurrent]);
		console.log(sky.status + ": " + sky[sky.status][rgbCurrent]);
		if (sky.current[rgbCurrent] > sky[sky.status][rgbCurrent]) {
			sky.current[rgbCurrent] -= 2;
		}	
		if (sky.current[rgbCurrent] < sky[sky.status][rgbCurrent]) {
			sky.current[rgbCurrent] += 2;
		}	
		if (sky.current[rgbCurrent] - sky[sky.status][rgbCurrent] === 1 || sky.current[rgbCurrent] - sky[sky.status][rgbCurrent] === -1) {
			sky.current[rgbCurrent] = sky[sky.status][rgbCurrent];
		}
	}
	
	
	sunset = {
		y: 100,
		size: 50,
		gradient: c.createRadialGradient(sun.xPosition,sun.yPosition, sun.sizeStart, sun.xPosition, sun.yPosition, sun.sizeEnd),
	}
/*	sunset.gradient.addColorStop(0,"white");
	sunset.gradient.addColorStop(0.1,"white");
	sunset.gradient.addColorStop(0.6,"yellow");
	//if (sun.yPosition < 400) {
		sunset.gradient.addColorStop(0.7,"rgb(" + sky.current.r + "," + sky.current.g + "," + sky.current.b);
		sunset.gradient.addColorStop(0.7,"rgb(" + sky.current.r + "," + sky.current.g + "," + sky.current.b);
		sunset.gradient.addColorStop(0.9,"darkblue"); */
		
		sunset.gradient.addColorStop(0,"yellow");
	//sunset.gradient.addColorStop(0.0016,"white");
	sunset.gradient.addColorStop(0.0035,"yellow");
	//if (sun.yPosition < 400) {
		sunset.gradient.addColorStop(0.015,"yellow");
		sunset.gradient.addColorStop(0.023,"rgb(" + sky.current.r + "," + sky.current.g + "," + sky.current.b);
//		sunset.gradient.addColorStop(0.017,"rgb(" + sky.current.r + "," + sky.current.g + "," + sky.current.b);
		sunset.gradient.addColorStop(0.9,"darkblue");
		
		
	//} else {
		//sunset.gradient.addColorStop(0.7,"orange");
		//sunset.gradient.addColorStop(1,"orange");
	//}
}

function drawBackground() {
	// clear canvas and draw background
	clear(c);  
	c.beginPath();
	c.fillStyle = sunset.gradient;
	c.strokeStyle = "black";
	c.rect(0,0,800,600);
	c.fill();
	c.stroke();
	c.closePath();
}





/////////////////////////////////////
/////////////////////////////////////
// drawing function / game loop//////
/////////////////////////////////////
/////////////////////////////////////

function mainDraw(canvas, message) {


updateBackground();
drawBackground();





// detect player movement
playerMove();
updateCamera();

// draw player, platform, bad guys, coins

drawPlatforms();
drawPlayer();

// bullets
updateBullets();
drawBullets();

// bad guys
drawBadGuys();


// coins
drawCoins();
checkCoinCollision();
// check the player is on a platform
//checkPlatform();

drawHUD();


///////////////////////////////////////
///////////////////////////////////////
/////////End of main game loop/////////
///////////////////////////////////////
///////////////////////////////////////
  
}


// key press detection

function playerMove(){
	if (keys[65]) {
		if (Player1.speed > -Player1.maxSpeed) {
			if (Player1.speed > -3) {
				Player1.speed -= .1;
			} else {
				Player1.speed -= .3;
			}
		}
		if (Player1.speed > 0) {
			Player1.speed -= .2;
		}
	}
	
	if (keys[68]) {
		if (Player1.speed < Player1.maxSpeed) {
			if (Player1.speed < 3) {
				Player1.speed += .1;
			} else {
				Player1.speed += .3;
			}
		}
		if (Player1.speed < 0) {
			Player1.speed += .2;
		}
	}
	
	if (!keys[68] && !keys[65]) {
		if (Player1.speed > 0) {
			Player1.speed -= .1;
		}
		if (Player1.speed < 0) {
			Player1.speed += .1;
		}
	}
	
	if (Player1.speed < 0.1 && Player1.speed > -0.1) {
		Player1.speed = 0;
	}
	

	
	checkPlatform();
	
	
		// check Platform collision
	platformCollision = false;
	thePlatforms.forEach ( function(i, j) {
	if (collidesSpecific(Player1.x + Player1.speed, Player1.y - Player1.jumpSpeed, Player1.w, Player1.h, i.x, i.y, i.w, i.h)) {

			console.log("Platform Collision");
			Player1.speed = 0;
			
			if (Player1.x < i.x + i.w && Player1.x + Player1.w > i.x) {
				Player1.jumpSpeed = 0;
				jumping = false;
				platformCollision = true;
			}
		}
	
	});
		
	if (keys[87]){
		console.log(Player1.onPlatform);
		if (Player1.onPlatform > -1) {
			jumping = true;
		}
	} 
	
	if (keys[83]) {
		if (jumping) {
			jumping = false;
		}
	}
	
	if (jumping) {
		Player1.jumpSpeed = 10;
		
		if (jumped > (Player1.jumpHeight * .5)) {
			Player1.jumpSpeed = 10;
		}
		if (jumped > (Player1.jumpHeight * .7)) {
			Player1.jumpSpeed = 8;
		}
		if (jumped > (Player1.jumpHeight * .85)) {
			Player1.jumpSpeed = 6;
		}
		if (jumped > (Player1.jumpHeight * 1 )) {
			Player1.jumpSpeed = 5;
		}
		// else 
		if (jumped > (Player1.jumpHeight * 1.05 )) {
			Player1.jumpSpeed = 4;
		}
		if (jumped > (Player1.jumpHeight * 1.1 )) {
			Player1.jumpSpeed = 3;
		}
		if (jumped > (Player1.jumpHeight * 1.15 )) {
			Player1.jumpSpeed = 2;
		}
		if (jumped > (Player1.jumpHeight * 1.2 )) {
			Player1.jumpSpeed = 0;
		}
	
		
		if (jumped < Player1.jumpHeight) {
			jumped += Player1.jumpSpeed;
		} else {
			jumped += Player1.jumpSpeed;
		}
	} else {
	Player1.jumpSpeed = 0;
	}
	
	
	// now move the player
	
	
	
	
	if (Player1.onPlatform === -1 || Player1.jumpSpeed != 0) {
		moveY = true;
	} else {
		moveY = false;
	}
	//console.log (Player1.speed);
	//console.log (Player1.x < Player1.w - 100);
	
	if ( (Player1.speed < 0 && Player1.x > 0) || (Player1.speed > 0 && Player1.x < WIDTH - Player1.w) ) {
		moveX = true;
	} else {
		moveX = false;
	}
	
	if (moveX) {
		Player1.x += Player1.speed;
	}
	
	if (moveY) {
		Player1.y -= Player1.jumpSpeed;
		if (Player1.onPlatform === -1) {
			Player1.y += 4;
		}
	}
	
	return false;
}

//// move objects around camera
function moveEverything(){
	
}




// event listeners
canvas.addEventListener("keydown", function (e) {
	keys[e.keyCode] = true;
});
canvas.addEventListener("keyup", function (e) {
	keys[e.keyCode] = false;
});
canvas.addEventListener("keyup", function (e) {
	keys2[e.keyCode] = true;
	keyUpHolder = keys2[e.keyCode];
});

canvas.addEventListener('mousemove', mouseMove, true);

canvas.addEventListener("click", function() {
	createBullet(mouse.x + camera.x, mouse.y + camera.y, Player1.x + (Player1.w / 2), Player1.y + (Player1.h / 2)  );
});

// Detect mouse movement and assign to mouseX, mouseY
function mouseMove(e) {
    if (e.offsetX) {
        mouse.x = e.offsetX;
        mouse.y = e.offsetY;
    }
    else if (e.layerX) {
        mouse.x = e.layerX;
        mouse.y = e.layerY;
    }
}




} // init
</script>

</head>

<body onload="init()">
<div id = "holder">
<canvas id="canvas" width="800" height="600" tabindex='1'></canvas>
</div>
<div style="text-align:center;"><br/><br/>w = up <br/> a = left <br/> s = down<br/> d = right<br/> left shift = sprint<br/> mouse = aim<br/> left click = shoot<br/> Refresh page to play again.</div>
</body>

</html>