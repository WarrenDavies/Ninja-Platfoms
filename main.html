<!DOCTYPE html>
<html>
<head>
<script src="map.js" type="text/javascript"></script>
<style>
body{
margin:0;
}

canvas {
border: solid 5px black;
position:relative;
}

#holder {
display:block;
margin: 100px auto 0 auto;
width:800px;
height:600px;
}
</style>

<script>

function init() {

console.log("start");
var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
window.requestAnimationFrame = requestAnimationFrame;

// define variables
var canvas, c;
var INTERVAL = 20;

// set up canvas
canvas = document.getElementById("canvas");
canvas.width = 800;
canvas.height = 600;
c = canvas.getContext("2d");
var WIDTH = canvas.width;
var HEIGHT = canvas.height;
var keyUpHolder = 0;

// initial canvas background 
c.beginPath();
c.fillStyle = "#3399FF";
c.rect(0,0,800,600);
c.fill();
c.closePath();

var WIDTH = canvas.width;
var HEIGHT = canvas.height;
setInterval(mainDraw, INTERVAL);
var keys = [];
var keys2 = [];
var theBadGuys = [];
var thePlatforms = [];
var e = 0;
var camera = {x: 0, y: 0, w: 800, h: 600};
var tileSize = 50;
var mapSize = {
		h: (map.length * tileSize),
		w: (map[0].length * tileSize),
	}


var platformCollision = true;
var onPlatform = true;
var jumping = false;
var jumped = 0;
var moveY = false;
var moveX = false;
var moved = false;
var platformCollision = false;
var theCoins = [];
var coinsCollected = 0;
var spliced = 0;


function badGuy() {
	this.x = 700;
	this.y = 1000;
	this.w = 20;
	this.h = 60;
	this.maxSpeed = 4;
	this.speed = 1;
	this.fill = 'blue';
}

theBadGuys.push({
	x:700,
	y:780,
	w:50,
	h:50,
	maxSpeed:4,
	speed:1,
	border:'red',
	fill:'red'
}); // first one

theBadGuys.push({
	x:1600,
	y:700,
	w:50,
	h:50,
	maxSpeed:4,
	speed:1,
	border:'red',
	fill:'red'
}); // near vertical wall

theBadGuys.push({
	x:1400,
	y:900,
	w:50,
	h:50,
	maxSpeed:4,
	speed:1,
	border:'red',
	fill:'red'
}); // below vertical wall





// triple coin batch
theCoins.push({
	x:30,
	y:780,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

theCoins.push({
	x:80,
	y:780,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

theCoins.push({
	x:130,
	y:780,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

// triple coin batch
theCoins.push({
	x:30,
	y:650,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

theCoins.push({
	x:80,
	y:650,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

theCoins.push({
	x:130,
	y:650,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

// triple coin batch
theCoins.push({
	x:610,
	y:540,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

theCoins.push({
	x:660,
	y:540,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

theCoins.push({
	x:710,
	y:540,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

// triple coin batch
theCoins.push({
	x:20,
	y:360,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

theCoins.push({
	x:70,
	y:360,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

theCoins.push({
	x:120,
	y:360,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});


// triple coin batch - three above the big jump
theCoins.push({
	x:920,
	y:360,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});
theCoins.push({
	x:970,
	y:360,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});
theCoins.push({
	x:1020,
	y:360,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});


// triple coin batch
theCoins.push({
	x:1720,
	y:840,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

theCoins.push({
	x:1800,
	y:800,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

theCoins.push({
	x:1880,
	y:760,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

theCoins.push({
	x:1825,
	y:530,
	w:45,
	h:45,
	fill:'yellow',
	border:'yellow',
	borderWidth: 0
});

// push platforms. Might need to have separate functions to load levels later.	  
	  
// the ground
thePlatforms.push({
	x:-20,
	y:830,
	w:840,
	h:400,
	fill:'green',
	border:'green',
	borderWidth: 0
});
thePlatforms.push({
	x:-20,
	y:850,
	w:840,
	h:400,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
});

thePlatforms.push({
	x:1900,
	y:830,
	w:840,
	h:400,
	fill:'green',
	border:'green',
	borderWidth: 0
});
thePlatforms.push({
	x:1900,
	y:850,
	w:840,
	h:400,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
});
// /ground

thePlatforms.push({
	x:-20,
	y:700,
	w:200,
	h:30,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
});
thePlatforms.push({
	x:-20,
	y:700,
	w:200,
	h:10,
	fill:'green',
	border:'green',
	borderWidth: 0
});
thePlatforms.push({
	x:-20,
	y:480,
	w:20,
	h:430,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
});//wall

thePlatforms.push({
	x:600,
	y:600,
	w:220,
	h:30,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
});
thePlatforms.push({
	x:600,
	y:599,
	w:220,
	h:10,
	fill:'green',
	border:'green',
	borderWidth: 0
});
thePlatforms.push({
	x:800,
	y:610,
	w:20,
	h:250,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
});// wall


thePlatforms.push({
	x:-20,
	y:400,
	w:200,
	h:30,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
});
thePlatforms.push({
	x:-20,
	y:400,
	w:200,
	h:10,
	fill:'green',
	border:'green',
	borderWidth: 0
});

thePlatforms.push({
	x:1200,
	y:600,
	w:200,
	h:30,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
});
thePlatforms.push({
	x:1200,
	y:600,
	w:200,
	h:10,
	fill:'green',
	border:'green',
	borderWidth: 0
});



thePlatforms.push({
	x:1400,
	y:950,
	w:200,
	h:30,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
});
thePlatforms.push({
	x:1400,
	y:950,
	w:200,
	h:10,
	fill:'green',
	border:'green',
	borderWidth: 0
});




thePlatforms.push({
	x:1600,
	y:750,
	w:200,
	h:30,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
});
thePlatforms.push({
	x:1600,
	y:750,
	w:200,
	h:10,
	fill:'green',
	border:'green',
	borderWidth: 0
});
thePlatforms.push({
	x:1780,
	y:250,
	w:20,
	h:520,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
}); // vertical wall

thePlatforms.push({
	x:1900,
	y:500,
	w:20,
	h:200,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
}); //wall enclosing coin

thePlatforms.push({
	x:1800,
	y:500,
	w:100,
	h:20,
	fill:'#6B2400',
	border:'#6B2400',
	borderWidth: 0
}); 


// /ground


jumpUp = new Image();
jumpUp.src = 'jumpUP.png';
    
function updateCamera() {
	camera.y = Player1.y + (Player1.h / 2) - (camera.h / 2);
}

function drawMap() {
	var onXTile = Math.floor((camera.x + (camera.w / 2)) / tileSize);
	var onYTile = Math.floor((camera.y + (camera.h / 2)) / tileSize);
	c.beginPath();
		for (j = onYTile - 13; j < onYTile + 13; j++ ) {
			for (l = onXTile - 17; l < onXTile + 17; l++) {
				if (j >= 0 && l >= 0 && j < map.length && l < map[j].length) {
				//c.fillStyle = map[j][l];
				c.fillStyle = "#3399FF";
				c.fillRect(l * tileSize - camera.x, j * tileSize - camera.y, tileSize, tileSize);
				} // check tile is in bounds
			} // for loop - x axis
		} // for loop - y axis
	}
	
	
function Player() {
	this.x = (WIDTH / 2) - 25;
	this.y = (HEIGHT / 2) - 25 + 500;
	this.w = 50;
	this.h = 50;
	this.maxSpeed = 6;
	this.speed = 0;
	this.jumpSpeed = 0;
	this.maxJumpSpeed = 6;
	this.jumpHeight = 500;
	this.momentum = 'none';
	this.fill = 'blue';
}
var Player1 = new Player();
updateCamera();
console.log(Player1);

function clear(c) {
	c.clearRect(0, 0, WIDTH, HEIGHT);
}

function drawCoins() {
	theCoins.forEach(function(i, j){
		c.beginPath();
		c.save();
		c.fillStyle = i.fill;
		c.arc(i.x + (i.w / 2) - camera.x, i.y + (i.h / 2) - camera.y, i.w / 2, 0, 2 * Math.PI, false);
		c.fill();
		c.restore();
		c.closePath();
	});
} 

function drawPlatforms() {
	thePlatforms.forEach(function(i,j){
		c.beginPath();
		c.save();
		c.fillStyle = i.fill;
		c.lineWidth = i.borderWidth;
		c.strokeStyle = i.border;
		c.rect(i.x - camera.x, i.y - camera.y, i.w, i.h);  
		c.stroke();
		c.fill();
		c.restore();
		c.closePath();
	});
}

function drawPlayer() {
	c.beginPath();
	c.save();
	c.strokeStyle = Player1.border;
	c.fillStyle = Player1.fill;
	c.lineWidth = 0;


	c.rect(Player1.x - camera.x, Player1.y - camera.y, Player1.w, Player1.h);   
	
	c.stroke();
	c.fill();
	c.restore();
	c.closePath();
}

function drawBadGuys() {
	theBadGuys.forEach(function(i,j){
		c.beginPath();
		c.save();
		c.fillStyle = i.fill;
		c.lineWidth = 0;
		c.strokeStyle = i.border;
		c.rect(i.x - camera.x, i.y - camera.y, i.w, i.h);  
		c.stroke();
		c.fill();
		c.restore();
		c.closePath();
	});
}

// collision detection routine where 2 objects have h and w
function collidesObjects(a, b) {
	return	a.x < b.x + b.w &&
			a.x + a.w > b.x &&
			a.y < b.y + b.h &&
			a.y + a.h > b.y;
}

// collision detection where w and h must be specified
function collidesSpecific(ax, ay, aw, ah, bx, by, bw, bh) {
	return  ax < bx + bw &&
			ax + aw > bx &&
			ay < by + bh &&
			ay + ah > by;
}

// collision detection between player and platforms
function checkPlatform() {
	thePlatforms.forEach ( function(i, j) {
		if (collidesSpecific(i, Player1)) {
			onPlatform = true;
		} else {
			onPlatform = false;
			Player1.fill = 'blue';
		}
	});
//c.fillText("onPlatform = " + onPlatform, 500, 120);	
}

function drawHUD() {
	c.fillStyle = "black";
	c.font = 'bold 28pt Calibri';
	c.fillText("Coins:" + coinsCollected, 20, 30);

}

function checkCoinCollision() {
	if (moveY === true || moveX === true) {
		for (j = theCoins.length - 1; j >= 0; j--) {
			if (collidesObjects(Player1, theCoins[j])) {
				theCoins.splice(j, 1);
				coinsCollected += 1;
			}
		}
	}
}

/////////////////////////////////////
/////////////////////////////////////
// drawing function / game loop//////
/////////////////////////////////////
/////////////////////////////////////
function mainDraw(canvas, message) {

// clear canvas and draw background
clear(c);  

c.beginPath();

c.fillStyle = "#3399FF";
c.strokeStyle = "black";
c.rect(0,0,800,600);
c.fill();
c.stroke();
c.closePath();




// detect player movement
playerMove();
updateCamera();
drawMap();

// draw player, platform, bad guys, coins
drawHUD();
drawPlatforms();
drawPlayer();
drawBadGuys();
drawCoins();
checkCoinCollision();
// check the player is on a platform
checkPlatform();



///////////////////////////////////////
///////////////////////////////////////
/////////End of main game loop/////////
///////////////////////////////////////
///////////////////////////////////////
  
}


// key press detection

function playerMove(){
	if (keys[65]) {
		if (Player1.speed > -Player1.maxSpeed) {
			if (Player1.speed > -3) {
				Player1.speed -= .1;
			} else {
				Player1.speed -= .3;
			}
		}
		if (Player1.speed > 0) {
			Player1.speed -= .2;
		}
	}
	
	if (keys[68]) {
		if (Player1.speed < Player1.maxSpeed) {
			if (Player1.speed < 3) {
				Player1.speed += .1;
			} else {
				Player1.speed += .3;
			}
		}
		if (Player1.speed < 0) {
			Player1.speed += .2;
		}
	}
	
	if (!keys[68] && !keys[65]) {
		if (Player1.speed > 0) {
			Player1.speed -= .1;
		}
		if (Player1.speed < 0) {
			Player1.speed += .1;
		}
	}
	
	if (Player1.speed < 0.1 && Player1.speed > -0.1) {
		Player1.speed = 0;
	}
	

	
	// check if on Platform
	thePlatforms.forEach ( function(i, j) {
		if (collidesSpecific (Player1.x, Player1.y + 3, Player1.w, Player1.h, i.x, i.y, i.w, i.h)) {
			onPlatform = true;
			jumped = 0;
			jumping = false;
			console.log("We're on a platform");
			Player1.y = i.y - Player1.h;
			if (Player1.speed === 0) {
				if (i.x + i.w < Player1.x + (Player1.w / 2) || i.x > Player1.x + (Player1.w / 2) ) {
					Player1.fill = 'orange';
				} else {
				Player1.fill = 'blue';
				}
			}
		} else {
		
		}
	});
	
		// check Platform collision
	platformCollision = false;
	thePlatforms.forEach ( function(i, j) {
	if (collidesSpecific(Player1.x + Player1.speed, Player1.y - Player1.jumpSpeed, Player1.w, Player1.h, i.x, i.y, i.w, i.h)) {

			console.log("Platform Collision");
			Player1.speed = 0;
			Player1.jumpSpeed = 0;
			jumping = false;
			platformCollision = true;
		}
	
	});
		
	if (keys[87]){
		if (onPlatform === true) {
			jumping = true;
		}
	} 
	
	if (keys[83]) {
		if (jumping) {
			jumping = false;
		}
	}
	
	if (jumping) {
		Player1.jumpSpeed = 10;
		
		if (jumped > (Player1.jumpHeight * .5)) {
			Player1.jumpSpeed = 10;
		}
		if (jumped > (Player1.jumpHeight * .7)) {
			Player1.jumpSpeed = 8;
		}
		if (jumped > (Player1.jumpHeight * .85)) {
			Player1.jumpSpeed = 6;
		}
		if (jumped > (Player1.jumpHeight * 1 )) {
			Player1.jumpSpeed = 5;
		}
		// else 
		if (jumped > (Player1.jumpHeight * 1.05 )) {
			Player1.jumpSpeed = 4;
		}
		if (jumped > (Player1.jumpHeight * 1.1 )) {
			Player1.jumpSpeed = 3;
		}
		if (jumped > (Player1.jumpHeight * 1.15 )) {
			Player1.jumpSpeed = 2;
		}
		if (jumped > (Player1.jumpHeight * 1.2 )) {
			Player1.jumpSpeed = 0;
		}
	
		
		if (jumped < Player1.jumpHeight) {
			jumped += Player1.jumpSpeed;
		} else {
			jumped += Player1.jumpSpeed;
		}
	} else {
	Player1.jumpSpeed = 0;
	}
	
	
	// now move the player
	
	
	
	
	if (onPlatform === false || Player1.jumpSpeed != 0) {
		moveY = true;
	}
	if (Player1.Speed != 0) {
		moveX = true;
	}
	if (moveY === true || moveX === true) {
		Player1.x += Player1.speed;
		
		Player1.y -= Player1.jumpSpeed;
		if (onPlatform === false) {
			Player1.y += 4;
		}
		
		console.log (Player1.jumpSpeed);
		console.log(onPlatform);
	}
	
	return false;
}

//// move objects around camera
function moveEverything(){
	
}




// event listeners
canvas.addEventListener("keydown", function (e) {
	keys[e.keyCode] = true;
});
canvas.addEventListener("keyup", function (e) {
	keys[e.keyCode] = false;
});
canvas.addEventListener("keyup", function (e) {
	keys2[e.keyCode] = true;
	keyUpHolder = keys2[e.keyCode];
});

canvas.addEventListener("click", function() {
	
});



} // init
</script>

</head>

<body onload="init()">
<div id = "holder">
<canvas id="canvas" width="800" height="600" tabindex='1'></canvas>
</div>
<div style="text-align:center;"><br/><br/>w = up <br/> a = left <br/> s = down<br/> d = right<br/> left shift = sprint<br/> mouse = aim<br/> left click = shoot<br/> Refresh page to play again.</div>
</body>

</html>